
<!DOCTYPE html>
<html>
<head>
	<title>Leaflet GeoJSON Example</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/lib/leaflet/css/leaflet.css" />
	<script src="/lib/leaflet/js/leaflet.js"></script>
	<script src="/lib/jquery/js/jquery-2.1.1.js"></script>
</head>
<body>
	<div id="map" style="width: 1000px; height: 700px"></div>
	<div id="status">Ready</div>
	<input type="text" id="owner_name"/>
	<input type="checkbox" id="neighborhood"/>
	<input type="checkbox" id="properties"/>
	<button text="multipoly" id="multipoly"/>
	<script>
		var map = L.map('map').setView([39.2854197594374,-76.61796569824219], 12);

		L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a>'
		}).addTo(map);

		var parcels, parcels2;
		var refreshParcels = function(){
			$('#status').html('Loading...');
			var bounds = map.getBounds();
			$.ajax({
			  url: "/bounds",
			  data: {
			  	bbox: bounds.getSouth()+','+bounds.getWest()+','+bounds.getNorth()+','+bounds.getEast()
			  }
			}).done(function( data ) {
				if (parcels) {
					map.removeLayer(parcels);
				}
				parcels = L.geoJson(data, {
					style: function(feature) {
						var color = (feature.properties.primary_owner_name)?'#00f':'#0f0';
						return {
							color: color
						};
					},
					onEachFeature: function(feature, layer) {
						var msg = '';
						for (prop in feature.properties){
							msg = msg + prop + ': ' + feature.properties[prop] + '<br/>';
						}
						layer.bindPopup(msg);
					}
				});
				parcels.addTo(map);
				$('#status').html('Ready');
			});
		};

		map.on('moveend', refreshParcels);
		map.on('zoomend', refreshParcels);

		$('#owner_name').on('keyup', function(){
			$('#status').html('Loading...');
			$.ajax({
			  url: "/owners",
			  data: {
			  	owner_name: $('#owner_name').val()
			  }
			}).done(function( data ) {
				if (parcels2) {
					map.removeLayer(parcels2);
				}
				parcels2 = L.geoJson(data, {
					style: function(feature) {
						return {
							color: "#000"
						};
					},
					onEachFeature: function(feature, layer) {
						var msg = '';
						for (prop in feature.properties){
							msg = msg + prop + ': ' + feature.properties[prop] + '<br/>';
						}
						layer.bindPopup(msg);
					}
				});
				parcels2.addTo(map);
				$('#status').html('Ready');
			});
		});

		$('#multipoly').on('click', function(){
			$('#status').html('Loading...');
			$.ajax({
			  url: "/multipoly"
			}).done(function( data ) {
				if (parcels2) {
					map.removeLayer(parcels2);
				}
				parcels2 = L.geoJson(data, {
					style: function(feature) {
						return {
							color: "#F00"
						};
					},
					onEachFeature: function(feature, layer) {
						var msg = '';
						for (prop in feature.properties){
							msg = msg + prop + ': ' + feature.properties[prop] + '<br/>';
						}
						layer.bindPopup(msg);
					}
				});
				parcels2.addTo(map);
				$('#status').html('Ready');
			});
		});

	</script>
</body>
</html>
